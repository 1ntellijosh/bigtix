# ------------------------------------------------------------------------------------------------
# Ansible script for setting secret vars in the development environment
# @since ansible--JP
# ------------------------------------------------------------------------------------------------

- name: Inject secrets into local development kind cluster environment
  hosts: localhost

  vars:
    project_root: "{{ playbook_dir }}/../.."

  tasks:
    - name: Check if dev-vars.yml exists
      ansible.builtin.stat:
        path: "{{ project_root }}/dev-vars.yml"
      register: dev_vars_stat

    - name: Fail when dev-vars.yml is missing (run dev-init first)
      ansible.builtin.assert:
        that: dev_vars_stat.stat.exists
        fail_msg: "dev-vars.yml not found. Run 'make init' so dev-init.yml creates it first."
      when: not dev_vars_stat.stat.exists

    - name: Load dev-vars.yml (get JWT_SECRET etc.)
      ansible.builtin.include_vars:
        file: "{{ project_root }}/dev-vars.yml"

    - name: Set jwt_secret from dev-vars.yml
      ansible.builtin.set_fact:
        jwt_secret: "{{ JWT_SECRET }}"

    - name: Create Kubernetes secret jwt-secret from prompted JWT key
      ansible.builtin.shell: >
        kubectl create secret generic jwt-secret
        --from-literal=JWT={{ jwt_secret }}
        --dry-run=client -o yaml
        | kubectl apply -f -
      args:
        chdir: "{{ project_root }}"
      register: jwt_secret_result
      changed_when: "'configured' in jwt_secret_result.stdout or 'created' in jwt_secret_result.stdout"
