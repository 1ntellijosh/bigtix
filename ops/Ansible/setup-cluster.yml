# ------------------------------------------------------------------------------------------------
# Ansible script for setting up local cluster environment for BigTix E-Commerse platform development 
# @since ansible--JP
# ------------------------------------------------------------------------------------------------


- name: Setup local cluster environment for BigTix E-Commerse platform development
  hosts: localhost

  vars:
    project_root: "{{ playbook_dir }}/../.."
    # Custom image with rabbitmq_delayed_message_exchange plugin (x-delayed-message) for order.expired delay
    rabbitmq_image: "bigtix-rabbitmq:3.13-management"

  tasks:
    - name: Check if dev-vars.yml exists
      ansible.builtin.stat:
        path: "{{ project_root }}/dev-vars.yml"
      register: dev_vars_stat

    - name: Fail when dev-vars.yml is missing (run dev-init first)
      ansible.builtin.assert:
        that: dev_vars_stat.stat.exists
        fail_msg: "dev-vars.yml not found. Run 'make init' so dev-init.yml creates it first."
      when: not dev_vars_stat.stat.exists

    - name: Load dev-vars.yml (get JWT_SECRET etc.)
      ansible.builtin.include_vars:
        file: "{{ project_root }}/dev-vars.yml"

    - name: Initialize the local development cluster
      ansible.builtin.shell: >
        make kstart
      args:
        chdir: "{{ project_root }}"

    - name: Apply ingress-nginx controller deployment
      ansible.builtin.shell: >
        make init-ingress
      args:
        chdir: "{{ project_root }}"

    - name: Wait for ingress-nginx controller deployment (pods may not exist yet right after apply)
      ansible.builtin.shell: >
        make wait-ingress
      args:
        chdir: "{{ project_root }}"

    - name: Create messaging namespace if missing
      ansible.builtin.shell: >
        make add-messaging-namespace
      args:
        chdir: "{{ project_root }}"

    # Build RabbitMQ image with delayed message exchange plugin and load into Kind
    - name: Build RabbitMQ image with rabbitmq_delayed_message_exchange plugin
      ansible.builtin.shell: >
        docker build -t {{ rabbitmq_image }} -f {{ project_root }}/ops/docker/rabbitmq/Dockerfile {{ project_root }}
      args:
        chdir: "{{ project_root }}"

    - name: Load RabbitMQ image into Kind cluster
      ansible.builtin.shell: >
        kind load docker-image {{ rabbitmq_image }} --name bigtix-cluster
      args:
        chdir: "{{ project_root }}"

    # RabbitMQ: playbook applies Deployment/Service (Skaffold excludes it to avoid sync issues)
    - name: Create RabbitMQ auth secret in messaging namespace
      ansible.builtin.shell: >
        kubectl create secret generic rabbitmq-auth -n messaging
        --from-literal=password={{ (RABBITMQ_PASSWORD | default('bigtix-dev-rabbitmq')) | quote }}
        --dry-run=client -o yaml
        | kubectl apply -f -
      args:
        chdir: "{{ project_root }}"

    - name: Apply RabbitMQ Deployment and Service in messaging namespace
      ansible.builtin.shell: >
        kubectl apply -f {{ project_root }}/ops/k8s/deployments/rabbitmq-depl.yml
      args:
        chdir: "{{ project_root }}"

    - name: Set the RabbitMQ URL fact (from dev-vars password)
      ansible.builtin.set_fact:
        rabbitmq_url: "amqp://user:{{ RABBITMQ_PASSWORD | default('bigtix-dev-rabbitmq') }}@rabbitmq.messaging.svc.cluster.local:5672"

    - name: Inject RabbitMQ URL into deployments namespace secrets
      ansible.builtin.shell: >
        kubectl create secret generic rabbitmq-url
        --from-literal=RABBITMQ_URL={{ rabbitmq_url | quote }}
        --dry-run=client -o yaml
        | kubectl apply -f -
      args:
        chdir: "{{ project_root }}"
      register: rabbitmq_url_result
      changed_when: "'configured' in rabbitmq_url_result.stdout or 'created' in rabbitmq_url_result.stdout"

    - name: Set jwt_secret from dev-vars.yml
      ansible.builtin.set_fact:
        jwt_secret: "{{ JWT_SECRET }}"

    - name: Create Kubernetes secret jwt-secret from dev-vars.yml
      ansible.builtin.shell: >
        kubectl create secret generic jwt-secret
        --from-literal=JWT_KEY={{ jwt_secret }}
        --dry-run=client -o yaml
        | kubectl apply -f -
      args:
        chdir: "{{ project_root }}"
      register: jwt_secret_result
      changed_when: "'configured' in jwt_secret_result.stdout or 'created' in jwt_secret_result.stdout"

    - name: Set stripe_publishable_key from dev-vars.yml
      ansible.builtin.set_fact:
        stripe_publishable_key: "{{ STRIPE_PUBLISHABLE_KEY }}"

    - name: Create Kubernetes secret stripe-publishable-key from dev-vars.yml
      ansible.builtin.shell: >
        kubectl create secret generic stripe-publishable-key
        --from-literal=STRIPE_PUBLISHABLE_KEY={{ stripe_publishable_key }}
        --dry-run=client -o yaml
        | kubectl apply -f -
      args:
        chdir: "{{ project_root }}"
      register: stripe_publishable_key_result
      changed_when: "'configured' in stripe_publishable_key_result.stdout or 'created' in stripe_publishable_key_result.stdout"

    - name: Set stripe_secret_key from dev-vars.yml
      ansible.builtin.set_fact:
        stripe_secret_key: "{{ STRIPE_SECRET_KEY }}"

    - name: Create Kubernetes secret stripe-secret-key from dev-vars.yml
      ansible.builtin.shell: >
        kubectl create secret generic stripe-secret-key
        --from-literal=STRIPE_SECRET_KEY={{ stripe_secret_key }}
        --dry-run=client -o yaml
        | kubectl apply -f -
      args:
        chdir: "{{ project_root }}"
      register: stripe_secret_key_result
      changed_when: "'configured' in stripe_secret_key_result.stdout or 'created' in stripe_secret_key_result.stdout"

    - name: Set stripe_webhook_secret from dev-vars.yml
      ansible.builtin.set_fact:
        stripe_webhook_secret: "{{ STRIPE_WEBHOOK_SECRET }}"

    - name: Create Kubernetes secret stripe-webhook-key from dev-vars.yml
      ansible.builtin.shell: >
        kubectl create secret generic stripe-webhook-key
        --from-literal=STRIPE_WEBHOOK_SECRET={{ stripe_webhook_secret }}
        --dry-run=client -o yaml
        | kubectl apply -f -
      args:
        chdir: "{{ project_root }}"
      register: stripe_webhook_secret_result
      changed_when: "'configured' in stripe_webhook_secret_result.stdout or 'created' in stripe_webhook_secret_result.stdout"

    - name: Build shared packages
      ansible.builtin.shell: >
        make build-shared-packages
      args:
        chdir: "{{ project_root }}"

    - name: Build local dev images
      ansible.builtin.shell: >
        make build-dev-images
      args:
        chdir: "{{ project_root }}"

    - name: Load images into Kind cluster
      ansible.builtin.shell: >
        make kload-imgs
      args:
        chdir: "{{ project_root }}"

    - name: Apply deployments
      ansible.builtin.shell: >
        make apply-deployments
      args:
        chdir: "{{ project_root }}"

    - name: Apply ingress
      ansible.builtin.shell: >
        make apply-ingress
      args:
        chdir: "{{ project_root }}"

    - name: Cluster setup complete
      ansible.builtin.debug:
        msg:
          - "Cluster setup complete. Run 'make dev' to start the development environment."
          - "To open RabbitMQ management UI: Run 'make rabbit-management', then go to http://localhost:15672) in browser"